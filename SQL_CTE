TOINVQTY AS 
(
SELECT 
PT.JobNum, 
SUM(PT.TranQty) AS 'ToInv'
FROM 
PartTran PT
WHERE 
PT.TranType IN ('MFG-STK')
AND 
CONVERT(DATE,PT.TranDate,101)<= @CUTOFFDATE
GROUP BY PT.JobNum
),

SELECT 
DISTINCT
WIPVALUES.PartNum,
WIPVALUES.Item_Description,
WIPVALUES.JobNum,
WIPVALUES.StartDate 'Job_Order_Date',
WIPVALUES.WIPQty,
WIPVALUES.Prod_Qty,
COMPLETEDQTY.CompletedQty,
SHIPPEDQTY.ShippedQty,
ISNULL(TOINVQTY.ToInv,0) AS 'ToInv_Qty',
WIPVALUES.Qty_Relieved,
CASE WHEN 
LASTACTDATE.TranDate IS NULL THEN WIPVALUES.StartDate
ELSE CASE WHEN LASTACTDATE.TranDate IS NOT NULL 
THEN
LASTACTDATE.TranDate 
END END AS 'Last_Activity_Date',
CASE WHEN WIPVALUES.JobClosed = 1 THEN 'CLOSED' ELSE 'OPEN' END AS 'Job_Status',
WIPVALUES.ProdCode 'Product_Code'
FROM 
WIPVALUES 
LEFT OUTER JOIN TOINVQTY ON TOINVQTY.JobNum = WIPVALUES.JobNum
LEFT OUTER JOIN SHIPPEDQTY ON SHIPPEDQTY.JobNum = WIPVALUES.JobNum
LEFT OUTER JOIN COMPLETEDQTY ON COMPLETEDQTY.JobNum = WIPVALUES.JobNum
LEFT OUTER JOIN LASTACTDATE ON LASTACTDATE.JobNum = WIPVALUES.JobNum AND LASTACTDATE.jobparttran_rn = 1 
WHERE 
(LASTACTDATE.TranDate <= GETDATE() or LASTACTDATE.TranDate is null and (WIPVALUES.StartDate <= GETDATE()))
ORDER BY WIPVALUES.Jobnum
